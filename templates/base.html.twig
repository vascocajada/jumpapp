<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Welcome!{% endblock %}</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">
        {% block stylesheets %}
            {{ encore_entry_link_tags('app') }}
        {% endblock %}

        {% block javascripts %}
            {{ encore_entry_script_tags('app') }}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var notificationsBtn = document.getElementById('notifications-btn');
                    var notificationsBadge = document.getElementById('notifications-badge');
                    var notificationsDropdown = document.getElementById('notifications-dropdown');
                    if (notificationsBtn && notificationsBadge && notificationsDropdown) {
                        notificationsBtn.addEventListener('mouseenter', function() {
                            if (notificationsBadge.style.display !== 'none') {
                                fetch('{{ path('app_notifications_mark_read') }}', {
                                    method: 'POST',
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest',
                                        'Content-Type': 'application/json',
                                    },
                                    credentials: 'same-origin',
                                }).then(function(response) {
                                    if (response.ok) {
                                        notificationsBadge.style.display = 'none';
                                    }
                                });
                            }
                        });
                    }
                });
            </script>
        {% endblock %}
    </head>
    <body>
        {% if app.user %}
            <nav class="bg-gray-800 text-white p-4">
                <div class="container mx-auto flex justify-between items-center">
                    <div class="flex space-x-6">
                        <a href="{{ path('app_home') }}" class="hover:text-gray-300">Dashboard</a>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Connected Gmail Accounts Dropdown -->
                        <div class="relative group">
                            <button class="flex items-center space-x-1 hover:text-gray-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <span>Accounts</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                <div class="py-2">
                                    {% set gmailAccounts = app.user.gmailAccounts %}
                                    {% if gmailAccounts is empty %}
                                        <div class="px-4 py-2 text-sm text-gray-500">No Gmail accounts connected</div>
                                    {% else %}
                                        {% for account in gmailAccounts %}
                                            <div class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                <div class="flex items-center">
                                                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                                                        <span class="text-blue-600 font-semibold text-xs">{{ account.email|first|upper }}</span>
                                                    </div>
                                                    <span class="truncate">{{ account.email }}</span>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                    <div class="border-t border-gray-100 mt-2 pt-2">
                                        <a href="{{ path('connect_google_add_account') }}" 
                                           class="block px-4 py-2 text-sm text-blue-600 hover:bg-gray-100">
                                            + Add Gmail Account
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Notifications Dropdown -->
                        <div class="relative group" id="notifications-dropdown">
                            <button id="notifications-btn" class="flex items-center space-x-1 hover:text-gray-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V4a2 2 0 10-4 0v1.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                </svg>
                                <span>Notifications</span>
                                {% set unreadCount = app.user ? (app.user.notifications|filter(n => not n.isRead())|length) : 0 %}
                                <span id="notifications-badge" {% if unreadCount == 0 %}style="display:none"{% endif %} class="ml-1 bg-red-600 text-white text-xs rounded-full px-2 py-0.5">{{ unreadCount }}</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                <div class="py-2 max-h-96 overflow-y-auto">
                                    {% set notifications = app.user ? app.user.notifications|filter(n => not n.isRead())|slice(0, 10) : [] %}
                                    {% if notifications is empty %}
                                        <div class="px-4 py-2 text-sm text-gray-500">No new notifications</div>
                                    {% else %}
                                        {% for notification in notifications %}
                                            {% set typeColor = {
                                                'success': 'bg-green-100 text-green-800',
                                                'error': 'bg-red-100 text-red-800',
                                                'info': 'bg-blue-100 text-blue-800',
                                                'warning': 'bg-yellow-100 text-yellow-800'
                                            }[notification.type]|default('bg-gray-100 text-gray-600') %}
                                            <div class="px-4 py-2 text-sm {{ typeColor }} rounded mb-1 flex items-center">
                                                <span class="flex-1">{{ notification.message }}</span>
                                                {% if notification.relatedEmail %}
                                                    <a href="{{ path('app_email_show', {'id': notification.relatedEmail.id}) }}" class="ml-2 text-blue-600 hover:underline">View</a>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if app.user and config is defined %}
                            <form method="post" action="{{ path('app_toggle_list_unsubscribe') }}" class="ml-4">
                                <input type="hidden" name="_token" value="{{ csrf_token('toggle_list_unsubscribe') }}">
                                <label class="flex items-center cursor-pointer select-none">
                                    <span class="mr-2 text-xs text-gray-200">List-Unsubscribe</span>
                                    <span class="relative">
                                        <input type="checkbox" name="use_gmail_list_unsubscribe" onchange="this.form.submit()" {% if config.useGmailListUnsubscribe %}checked{% endif %} class="sr-only peer">
                                        <div class="w-10 h-5 bg-gray-400 rounded-full peer-checked:bg-blue-600 transition-colors"></div>
                                        <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transform peer-checked:translate-x-5 transition-transform"></div>
                                    </span>
                                </label>
                            </form>
                        {% endif %}
                        <span class="text-gray-300">{{ app.user.email }}</span>
                        <form method="post" action="{{ path('app_import_emails') }}" class="inline-block mx-2">
                            <input type="hidden" name="_token" value="{{ csrf_token('import_emails') }}">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">Import Emails</button>
                        </form>
                        <a href="{{ path('_logout_main') }}" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">Logout</a>
                    </div>
                </div>
            </nav>
        {% endif %}

        {# 
            Step-by-step explanation:
            1. We use the 'app.flashes' function to retrieve all flash messages, grouped by their type (e.g., 'success', 'error').
            2. We loop over each type and its messages.
            3. For each message, we display it in a div with a class based on the type, so you can style them differently in CSS.
        #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="fixed top-4 right-4 z-50 max-w-sm w-full">
                    <div class="{% if label == 'success' %}bg-green-50 border-green-200 text-green-800{% elseif label == 'error' %}bg-red-50 border-red-200 text-red-800{% elseif label == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %} border rounded-lg p-4 shadow-lg">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                {% if label == 'success' %}
                                    <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                {% elseif label == 'error' %}
                                    <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                {% elseif label == 'warning' %}
                                    <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                {% else %}
                                    <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                {% endif %}
                            </div>
                            <div class="ml-3 flex-1">
                                <p class="text-sm font-medium">{{ message }}</p>
                            </div>
                            <div class="ml-4 flex-shrink-0">
                                <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" class="{% if label == 'success' %}text-green-400 hover:text-green-600{% elseif label == 'error' %}text-red-400 hover:text-red-600{% elseif label == 'warning' %}text-yellow-400 hover:text-yellow-600{% else %}text-blue-400 hover:text-blue-600{% endif %} focus:outline-none focus:text-gray-500 transition ease-in-out duration-150">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
        {% block body %}{% endblock %}
    </body>
</html>
